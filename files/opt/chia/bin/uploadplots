#!/usr/bin/env bash

sync_dir=${1:?"ERROR: First positional argument sync dir required."}
sync_to=${2:?"ERROR: Second positional argument sync destination required."}

test -d ${sync_dir} || (echo "[`date`] ERROR: sync_dir must be a valid directory." && exit 1)

pushd ${sync_dir} >> /dev/null

  mkdir -p copying

  if [ `find ./ -maxdepth 1 -type f -name "*.plot" | wc -l` != 0 ]; then
    for f in `find ./ -maxdepth 1 -type f -name "*.plot"`; do
      mv ${f} ./copying/
      set +e
      for file in `find ./copying -type f -name "*.plot"`; do
        sync_dst=`ssh ${sync_to} ezplot plotdst`
        # Copy with scp so we can see the rate at which we copy.
        echo "[`date`] transfering plot: ${file} => ${sync_dst}"
        scp -i ~/.ssh/id_rsa ${file} ${sync_to}:${sync_dst}
        rsync -avhp -e "ssh -i ~/.ssh/id_rsa" --remove-source-files ${file} ${sync_to}:${sync_dst}
      done
      set -e
      # Follow up with rsync to verify the transfer and clean out the
      # source file.
      rsync -avhp -e "ssh -i ~/.ssh/id_rsa" --remove-source-files ./copying ${sync_to}:`ssh -i ~/.ssh/id_rsa ${sync_to} ezplot plotdst`
    done
  fi

popd >> /dev/null
